# 工具调用修复说明

## 问题描述

从日志中发现两个问题：

### 问题1: 参数格式错误
```
ERROR | 工具执行失败: missing 2 required positional arguments: 'date' and 'market_type'
参数: {'__arg1': "{'ticker': '688256', 'date': '2025-10-28', 'market_type': '中国A股'}"}
```

阿里百炼模型将参数包装成了字符串格式。

### 问题2: 工具参数数量错误
```
ERROR | 工具执行失败: Too many arguments to single-input tool get_market_sentiment_data
```

`Tool` 类默认只支持单个参数，但我们的函数有3个参数。

## 解决方案

### 1. 修复参数解析（市场情绪分析师）

**文件**: `tradingagents/agents/analysts/market_sentiment_analyst.py`

**添加参数解析逻辑**:
```python
# 处理阿里百炼的特殊参数格式
if '__arg1' in tool_args and isinstance(tool_args['__arg1'], str):
    try:
        import json
        import ast
        arg_str = tool_args['__arg1']
        # 先尝试JSON解析
        try:
            parsed_args = json.loads(arg_str)
        except:
            # 如果JSON失败，尝试ast.literal_eval
            parsed_args = ast.literal_eval(arg_str)
        
        tool_args = parsed_args
        logger.info(f"🔧 解析后的参数: {tool_args}")
    except Exception as e:
        logger.warning(f"⚠️ 参数解析失败: {e}")
```

### 2. 使用StructuredTool（情绪分析工具）

**文件**: `tradingagents/tools/sentiment_tools.py`

**修改前**:
```python
from langchain_core.tools import Tool

def create_sentiment_analysis_tool(...) -> Tool:
    def get_market_sentiment_data(ticker: str, date: str, market_type: str) -> str:
        ...
    
    tool = Tool(
        name="get_market_sentiment_data",
        description="...",
        func=get_market_sentiment_data  # ❌ Tool只支持单参数
    )
    return tool
```

**修改后**:
```python
from langchain_core.tools import Tool, StructuredTool
from pydantic import BaseModel, Field as PydanticField

def create_sentiment_analysis_tool(...) -> StructuredTool:
    # 定义输入模型
    class SentimentAnalysisInput(BaseModel):
        ticker: str = PydanticField(description="股票代码")
        date: str = PydanticField(description="分析日期 (YYYY-MM-DD)")
        market_type: str = PydanticField(description="市场类型")
    
    def get_market_sentiment_data(ticker: str, date: str, market_type: str) -> str:
        ...
    
    # 使用StructuredTool支持多参数
    tool = StructuredTool.from_function(
        func=get_market_sentiment_data,
        name="get_market_sentiment_data",
        description="...",
        args_schema=SentimentAnalysisInput  # ✅ 明确定义参数结构
    )
    return tool
```

## 技术细节

### Tool vs StructuredTool

| 特性 | Tool | StructuredTool |
|------|------|----------------|
| 参数数量 | 单个 | 多个 |
| 参数类型 | 字符串 | 结构化（Pydantic） |
| 类型检查 | 无 | 有 |
| 文档生成 | 简单 | 详细 |
| LLM理解 | 较差 | 较好 |

### 为什么使用StructuredTool？

1. **明确的参数定义**: LLM能更好地理解需要哪些参数
2. **类型安全**: Pydantic自动验证参数类型
3. **更好的错误提示**: 参数错误时有清晰的错误信息
4. **兼容性**: 支持所有LLM提供商的工具调用格式

### 阿里百炼的特殊处理

阿里百炼（DashScope）在某些情况下会将参数包装成字符串：
```python
# 正常格式
{'ticker': '688256', 'date': '2025-10-28', 'market_type': '中国A股'}

# 阿里百炼格式
{'__arg1': "{'ticker': '688256', 'date': '2025-10-28', 'market_type': '中国A股'}"}
```

我们的解析逻辑会自动处理这两种格式。

## 预期效果

### 修复前

```
ERROR | [市场情绪分析师] 执行工具: get_market_sentiment_data
ERROR | 参数: {'__arg1': "{'ticker': '688256', ...}"}
ERROR | ❌ 工具执行失败: Too many arguments to single-input tool
WARNING | ⚠️ 无法从报告中提取情绪评分，返回中性评分50
```

### 修复后

```
INFO | [市场情绪分析师] 执行工具: get_market_sentiment_data
INFO | 原始参数: {'__arg1': "{'ticker': '688256', ...}"}
INFO | 🔧 解析后的参数: {'ticker': '688256', 'date': '2025-10-28', 'market_type': '中国A股'}
INFO | ✅ 工具执行成功，结果长度: 1234 字符
INFO | ✅ 使用工具输出作为报告
INFO | ✅ 从报告中提取情绪评分: 65.5
```

## 测试步骤

### 1. 重启服务

```bash
docker-compose restart backend
```

### 2. 提交测试分析

```bash
# 通过Web界面或API提交一个分析请求
# 股票代码: 688256 (寒武纪)
```

### 3. 查看日志

检查日志中是否有：
- ✅ `🔧 解析后的参数`
- ✅ `✅ 工具执行成功`
- ✅ `✅ 从报告中提取情绪评分`

### 4. 验证结果

检查分析结果：
- `market_sentiment_report` 应该包含完整的情绪分析报告
- `sentiment_score` 应该是一个有意义的数字（不总是50）

## 兼容性

### 支持的LLM

修复后支持所有主流LLM：

- ✅ **OpenAI** (GPT-4, GPT-3.5)
- ✅ **阿里百炼** (Qwen) - 特殊参数格式已处理
- ✅ **DeepSeek** (DeepSeek-V3)
- ✅ **Google** (Gemini)
- ✅ **Anthropic** (Claude)
- ✅ **其他OpenAI兼容模型**

### 工具调用格式

支持多种工具调用格式：

```python
# 标准格式
{'ticker': '688256', 'date': '2025-10-28', 'market_type': '中国A股'}

# 阿里百炼格式
{'__arg1': "{'ticker': '688256', 'date': '2025-10-28', 'market_type': '中国A股'}"}

# JSON字符串格式
{'__arg1': '{"ticker": "688256", "date": "2025-10-28", "market_type": "中国A股"}'}
```

## 相关修改

### 修改的文件

1. **tradingagents/tools/sentiment_tools.py**
   - 导入 `StructuredTool` 和 `Pydantic`
   - 定义 `SentimentAnalysisInput` 模型
   - 使用 `StructuredTool.from_function` 创建工具

2. **tradingagents/agents/analysts/market_sentiment_analyst.py**
   - 添加参数解析逻辑
   - 处理阿里百炼的特殊格式
   - 改进日志输出

## 总结

✅ **修复了工具参数问题** - 使用StructuredTool支持多参数
✅ **处理了阿里百炼格式** - 自动解析特殊参数格式
✅ **改进了错误处理** - 更详细的日志和错误信息
✅ **提高了兼容性** - 支持所有主流LLM

现在市场情绪分析功能应该能够正常工作了！
