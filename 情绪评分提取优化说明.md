# æƒ…ç»ªè¯„åˆ†æå–ä¼˜åŒ–è¯´æ˜

## é—®é¢˜æè¿°

ä»æ—¥å¿—ä¸­å‘ç°ï¼š

```
INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] LLMè°ƒç”¨äº† 1 ä¸ªå·¥å…·
WARNING | æ— æ³•ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†ï¼Œè¿”å›ä¸­æ€§è¯„åˆ†50
```

å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆæˆåŠŸè°ƒç”¨äº†å·¥å…·ï¼Œä½†æ˜¯æ— æ³•ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†ã€‚

## é—®é¢˜åŸå› 

### 1. å·¥å…·è°ƒç”¨ç»“æœæœªæ­£ç¡®å¤„ç†

å½“LLMè°ƒç”¨å·¥å…·æ—¶ï¼Œ`result.tool_calls` åŒ…å«å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œä½† `result.content` å¯èƒ½æ˜¯ç©ºçš„æˆ–åªæ˜¯ç®€çŸ­çš„å“åº”ã€‚çœŸæ­£çš„å·¥å…·è¾“å‡ºéœ€è¦é€šè¿‡æ‰§è¡Œå·¥å…·è°ƒç”¨æ¥è·å–ã€‚

**ä¹‹å‰çš„é€»è¾‘**:
```python
if tool_call_count > 0:
    # æœ‰å·¥å…·è°ƒç”¨ï¼Œç›´æ¥ä½¿ç”¨result.content
    report = result.content  # âŒ è¿™é‡Œå¯èƒ½æ˜¯ç©ºçš„æˆ–ä¸å®Œæ•´
```

**ä¼˜åŒ–åçš„é€»è¾‘**:
```python
if tool_call_count > 0:
    # æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼Œè·å–çœŸæ­£çš„å·¥å…·è¾“å‡º
    for tool_call in result.tool_calls:
        tool_result = tool.invoke(tool_args)
        report = str(tool_result)  # âœ… ä½¿ç”¨å·¥å…·çš„å®é™…è¾“å‡º
```

### 2. è¯„åˆ†æå–æ¨¡å¼ä¸å¤Ÿå…¨é¢

åŸæ¥çš„æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼è¾ƒå°‘ï¼Œå¯èƒ½æ— æ³•åŒ¹é…æ‰€æœ‰æ ¼å¼ã€‚

## ä¼˜åŒ–å†…å®¹

### 1. å¢å¼ºå·¥å…·è°ƒç”¨å¤„ç†

**æ–‡ä»¶**: `tradingagents/agents/analysts/market_sentiment_analyst.py`

**ä¿®æ”¹ä½ç½®**: ç¬¬243-270è¡Œ

**æ–°å¢é€»è¾‘**:
```python
# å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œéœ€è¦æ‰§è¡Œå·¥å…·å¹¶è·å–ç»“æœ
if tool_call_count > 0:
    logger.info(f"[å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] ğŸ”§ æ‰§è¡Œå·¥å…·è°ƒç”¨...")
    
    try:
        # æ‰§è¡Œå·¥å…·è°ƒç”¨
        tool_messages = []
        for tool_call in result.tool_calls:
            tool_name = tool_call.get('name', '')
            tool_args = tool_call.get('args', {})
            
            # æ‰¾åˆ°å¯¹åº”çš„å·¥å…·å¹¶æ‰§è¡Œ
            for tool in tools:
                if tool.name == tool_name:
                    tool_result = tool.invoke(tool_args)
                    tool_messages.append(tool_result)
                    break
        
        # ä½¿ç”¨å·¥å…·ç»“æœä½œä¸ºæŠ¥å‘Š
        if tool_messages:
            report = str(tool_messages[0])
            logger.info(f"âœ… ä½¿ç”¨å·¥å…·è¾“å‡ºä½œä¸ºæŠ¥å‘Š")
        else:
            report = result.content
            
    except Exception as e:
        logger.error(f"âŒ å·¥å…·æ‰§è¡Œå¤±è´¥: {e}")
        report = result.content
```

### 2. å¢å¼ºè¯„åˆ†æå–æ¨¡å¼

**æ–‡ä»¶**: `tradingagents/agents/analysts/market_sentiment_analyst.py`

**ä¿®æ”¹ä½ç½®**: `_extract_sentiment_score` å‡½æ•°

**æ–°å¢æ¨¡å¼**:
```python
patterns = [
    # ä¸­æ–‡æ ¼å¼
    r'ç»¼åˆæƒ…ç»ªè¯„åˆ†[ï¼š:]\s*(\d+\.?\d*)\s*/?\s*100',  # ç»¼åˆæƒ…ç»ªè¯„åˆ†: 65.5 / 100
    r'ç»¼åˆæƒ…ç»ªè¯„åˆ†[ï¼š:]\s*(\d+\.?\d*)',              # ç»¼åˆæƒ…ç»ªè¯„åˆ†: 65.5
    r'æƒ…ç»ªè¯„åˆ†[ï¼š:]\s*(\d+\.?\d*)\s*/?\s*100',      # æƒ…ç»ªè¯„åˆ†: 65.5 / 100
    r'æƒ…ç»ªè¯„åˆ†[ï¼š:]\s*(\d+\.?\d*)',                  # æƒ…ç»ªè¯„åˆ†: 65.5
    r'å¸‚åœºæƒ…ç»ª[ï¼š:]\s*(\d+\.?\d*)',                  # å¸‚åœºæƒ…ç»ª: 65.5
    r'è¯„åˆ†[ï¼š:]\s*(\d+\.?\d*)\s*/?\s*100',          # è¯„åˆ†: 65.5 / 100
    r'è¯„åˆ†[ï¼š:]\s*(\d+\.?\d*)',                      # è¯„åˆ†: 65.5
    # è‹±æ–‡æ ¼å¼
    r'sentiment\s+score[ï¼š:]\s*(\d+\.?\d*)',        # sentiment score: 65.5
    r'score[ï¼š:]\s*(\d+\.?\d*)\s*/?\s*100',         # score: 65.5 / 100
    # æ•°å­—åè·Ÿ"åˆ†"
    r'(\d+\.?\d*)\s*åˆ†',                            # 65.5åˆ†
    # Markdownè¡¨æ ¼æ ¼å¼
    r'\*\*ç»¼åˆæƒ…ç»ªè¯„åˆ†\*\*[ï¼š:]\s*(\d+\.?\d*)',     # **ç»¼åˆæƒ…ç»ªè¯„åˆ†**: 65.5
    r'\*\*æƒ…ç»ªè¯„åˆ†\*\*[ï¼š:]\s*(\d+\.?\d*)',         # **æƒ…ç»ªè¯„åˆ†**: 65.5
]
```

**å¤‡é€‰æ–¹æ¡ˆ**:
```python
# å¦‚æœæ‰€æœ‰æ¨¡å¼éƒ½åŒ¹é…å¤±è´¥ï¼Œå°è¯•æŸ¥æ‰¾æŠ¥å‘Šä¸­çš„ä»»ä½•0-100ä¹‹é—´çš„æ•°å­—
all_numbers = re.findall(r'\b(\d+\.?\d*)\b', report)
for num_str in all_numbers:
    num = float(num_str)
    if 0 <= num <= 100 and num != 50:  # æ’é™¤50ï¼ˆé»˜è®¤å€¼ï¼‰
        logger.info(f"âš ï¸ ä½¿ç”¨æŠ¥å‘Šä¸­æ‰¾åˆ°çš„æ•°å­—ä½œä¸ºæƒ…ç»ªè¯„åˆ†: {num}")
        return num
```

## é¢„æœŸæ•ˆæœ

### ä¼˜åŒ–å‰

```
2025-10-28 13:33:52 | INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] LLMè°ƒç”¨äº† 1 ä¸ªå·¥å…·
2025-10-28 13:33:52 | WARNING | æ— æ³•ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†ï¼Œè¿”å›ä¸­æ€§è¯„åˆ†50
```

### ä¼˜åŒ–å

```
2025-10-28 13:33:52 | INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] LLMè°ƒç”¨äº† 1 ä¸ªå·¥å…·
2025-10-28 13:33:52 | INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] ğŸ”§ æ‰§è¡Œå·¥å…·è°ƒç”¨...
2025-10-28 13:33:52 | INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] æ‰§è¡Œå·¥å…·: get_market_sentiment_data
2025-10-28 13:33:52 | INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸï¼Œç»“æœé•¿åº¦: 1234 å­—ç¬¦
2025-10-28 13:33:52 | INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] âœ… ä½¿ç”¨å·¥å…·è¾“å‡ºä½œä¸ºæŠ¥å‘Š
2025-10-28 13:33:52 | INFO | âœ… ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†: 65.5
```

## æµ‹è¯•å»ºè®®

### 1. é‡å¯æœåŠ¡

```bash
docker-compose restart backend
```

### 2. è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯•å•ä¸ªè‚¡ç¥¨
python test_sentiment_analysis.py

# æˆ–é€šè¿‡Webç•Œé¢æµ‹è¯•
# æäº¤ä¸€ä¸ªåˆ†æè¯·æ±‚ï¼ŒæŸ¥çœ‹æ—¥å¿—
```

### 3. æ£€æŸ¥æ—¥å¿—

æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
- âœ… `æ‰§è¡Œå·¥å…·è°ƒç”¨...`
- âœ… `å·¥å…·æ‰§è¡ŒæˆåŠŸ`
- âœ… `ä½¿ç”¨å·¥å…·è¾“å‡ºä½œä¸ºæŠ¥å‘Š`
- âœ… `ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†: XX.X`

### 4. éªŒè¯ç»“æœ

æ£€æŸ¥åˆ†æç»“æœä¸­çš„ `sentiment_score` å­—æ®µï¼š
- åº”è¯¥æ˜¯ä¸€ä¸ª0-100ä¹‹é—´çš„æ•°å­—
- ä¸åº”è¯¥æ€»æ˜¯50ï¼ˆä¸­æ€§ï¼‰

## æŠ€æœ¯ç»†èŠ‚

### å·¥å…·è°ƒç”¨æµç¨‹

```
LLMç”Ÿæˆå“åº”
  â†“
æ£€æµ‹åˆ°tool_calls
  â†“
éå†æ¯ä¸ªtool_call
  â†“
æå–tool_nameå’Œtool_args
  â†“
æ‰¾åˆ°å¯¹åº”çš„å·¥å…·
  â†“
æ‰§è¡Œ tool.invoke(tool_args)
  â†“
è·å–å·¥å…·è¾“å‡º
  â†“
ä½¿ç”¨å·¥å…·è¾“å‡ºä½œä¸ºæŠ¥å‘Š
  â†“
ä»æŠ¥å‘Šä¸­æå–è¯„åˆ†
```

### è¯„åˆ†æå–æµç¨‹

```
æ¥æ”¶æŠ¥å‘Šæ–‡æœ¬
  â†“
å°è¯•æ ‡å‡†æ¨¡å¼åŒ¹é…
  â†“
æˆåŠŸ? â†’ è¿”å›è¯„åˆ†
  â†“ å¤±è´¥
å°è¯•å¤‡é€‰æ¨¡å¼
  â†“
æˆåŠŸ? â†’ è¿”å›è¯„åˆ†
  â†“ å¤±è´¥
æŸ¥æ‰¾0-100çš„æ•°å­—
  â†“
æ‰¾åˆ°? â†’ è¿”å›æ•°å­—
  â†“ å¤±è´¥
è¿”å›é»˜è®¤å€¼50
```

## å…¼å®¹æ€§

### æ”¯æŒçš„LLM

- âœ… OpenAI (GPT-4, GPT-3.5)
- âœ… é˜¿é‡Œç™¾ç‚¼ (Qwen)
- âœ… DeepSeek
- âœ… Google Gemini
- âœ… Anthropic Claude
- âœ… å…¶ä»–OpenAIå…¼å®¹çš„æ¨¡å‹

### æ”¯æŒçš„æŠ¥å‘Šæ ¼å¼

- âœ… Markdownæ ¼å¼
- âœ… çº¯æ–‡æœ¬æ ¼å¼
- âœ… ä¸­æ–‡/è‹±æ–‡æ··åˆ
- âœ… å¸¦è¡¨æ ¼çš„æŠ¥å‘Š
- âœ… å¸¦MarkdownåŠ ç²—çš„æŠ¥å‘Š

## å›æ»šæ–¹æ¡ˆ

å¦‚æœä¼˜åŒ–åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼š

```python
# ç®€å•çš„å¤„ç†é€»è¾‘
if tool_call_count > 0:
    report = result.content if hasattr(result, 'content') else str(result)
else:
    # å¼ºåˆ¶è°ƒç”¨å·¥å…·...
```

## æ€»ç»“

âœ… **ä¼˜åŒ–äº†å·¥å…·è°ƒç”¨å¤„ç†** - ç¡®ä¿æ­£ç¡®æ‰§è¡Œå·¥å…·å¹¶è·å–è¾“å‡º
âœ… **å¢å¼ºäº†è¯„åˆ†æå–** - æ”¯æŒæ›´å¤šæ ¼å¼å’Œå¤‡é€‰æ–¹æ¡ˆ
âœ… **æ”¹è¿›äº†æ—¥å¿—** - æ›´è¯¦ç»†çš„æ‰§è¡Œä¿¡æ¯
âœ… **æé«˜äº†é²æ£’æ€§** - å¤šå±‚é™çº§ç­–ç•¥

ç°åœ¨å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆåº”è¯¥èƒ½å¤Ÿæ­£ç¡®æå–æƒ…ç»ªè¯„åˆ†äº†ï¼
