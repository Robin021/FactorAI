# Authing ç”¨æˆ·ä¿¡æ¯è·å–é—®é¢˜ä¿®å¤æŒ‡å—

## ğŸ¯ é—®é¢˜æè¿°

Authing ç™»å½•åè·å–çš„ç”¨æˆ·ä¿¡æ¯æ˜¯éšæœºçš„ï¼Œæ— æ³•è·å–åˆ°çœŸå®çš„ç”¨æˆ·æ‰‹æœºå·æˆ–é‚®ç®±ã€‚

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

ç»è¿‡åˆ†æï¼Œé—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

1. **ç¯å¢ƒå˜é‡æœªæ­£ç¡®è®¾ç½®**ï¼š`AUTHING_APP_SECRET` è¿˜æ˜¯å ä½ç¬¦ `"your_app_secret_here"`
2. **Authing API è°ƒç”¨å¤±è´¥**ï¼šç”±äºå¯†é’¥ä¸æ­£ç¡®ï¼Œå¯¼è‡´æ— æ³•ä» Authing è·å–çœŸå®ç”¨æˆ·ä¿¡æ¯
3. **ä»£ç é€»è¾‘æ­£ç¡®**ï¼š`tradingagents_server.py` ä¸­çš„ä»£ç é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œå¤±è´¥æ—¶ä¼šè¿”å›é”™è¯¯é¡µé¢

## ğŸ› ï¸ ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: è·å– Authing åº”ç”¨å¯†é’¥

1. **ç™»å½• Authing æ§åˆ¶å°**
   ```
   https://console.authing.cn
   ```

2. **è¿›å…¥åº”ç”¨ç®¡ç†**
   - æ‰¾åˆ°åº”ç”¨ IDï¼š`68d3879e03d9b1907f220731`
   - ç‚¹å‡»è¿›å…¥åº”ç”¨è¯¦æƒ…

3. **è·å–åº”ç”¨å¯†é’¥**
   - åœ¨åº”ç”¨è¯¦æƒ…é¡µé¢æ‰¾åˆ°"åº”ç”¨å¯†é’¥"æˆ–"App Secret"
   - å¤åˆ¶å¯†é’¥å€¼ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸²å­—æ¯æ•°å­—ç»„åˆï¼‰

### æ­¥éª¤ 2: è®¾ç½®ç¯å¢ƒå˜é‡

ä½¿ç”¨æ–°çš„ç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬ï¼š

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x setup_authing_env_fixed.sh

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆæ›¿æ¢ä¸ºä½ çš„å®é™…å¯†é’¥ï¼‰
./setup_authing_env_fixed.sh your_actual_app_secret_here
```

### æ­¥éª¤ 3: æ£€æŸ¥ Authing ç”¨æˆ·æ± 

1. **è¿›å…¥ç”¨æˆ·ç®¡ç†**
   - åœ¨ Authing æ§åˆ¶å°ç‚¹å‡»"ç”¨æˆ·ç®¡ç†"

2. **åˆ›å»ºæµ‹è¯•ç”¨æˆ·**ï¼ˆå¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼‰
   - ç‚¹å‡»"æ·»åŠ ç”¨æˆ·"
   - å¡«å†™ç”¨æˆ·ä¿¡æ¯ï¼š
     - ç”¨æˆ·åï¼š`testuser`
     - é‚®ç®±ï¼š`test@example.com`
     - æ‰‹æœºå·ï¼š`13800138000`
     - å¯†ç ï¼š`Test123456`
   - ç¡®ä¿ç”¨æˆ·çŠ¶æ€ä¸º"å·²æ¿€æ´»"

3. **æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å®Œæ•´æ€§**
   - ç¡®ä¿ç”¨æˆ·å¡«å†™äº†é‚®ç®±å’Œæ‰‹æœºå·
   - æ£€æŸ¥ç”¨æˆ·è§’è‰²å’Œæƒé™é…ç½®

### æ­¥éª¤ 4: æµ‹è¯•ä¿®å¤ç»“æœ

1. **å¯åŠ¨æœåŠ¡**
   ```bash
   python tradingagents_server.py
   ```

2. **æµ‹è¯• SSO ç™»å½•**
   - è®¿é—® http://localhost:3000/login
   - ç‚¹å‡» "Authing SSO ç™»å½•" æŒ‰é’®
   - ä½¿ç”¨åˆ›å»ºçš„æµ‹è¯•ç”¨æˆ·ç™»å½•

3. **éªŒè¯ç”¨æˆ·ä¿¡æ¯**
   - ç™»å½•æˆåŠŸååº”è¯¥æ˜¾ç¤ºçœŸå®çš„ç”¨æˆ·ä¿¡æ¯
   - æ£€æŸ¥ç”¨æˆ·åã€é‚®ç®±ã€æ‰‹æœºå·æ˜¯å¦æ­£ç¡®

## ğŸ”§ ä»£ç ä¿®å¤è¯´æ˜

### ä¸»è¦ä¿®å¤ç‚¹

1. **ç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬**ï¼šåˆ›å»ºäº† `setup_authing_env_fixed.sh`ï¼Œæ”¯æŒä¼ å…¥å®é™…çš„åº”ç”¨å¯†é’¥

2. **é”™è¯¯å¤„ç†ä¼˜åŒ–**ï¼šç¡®ä¿ Authing API è°ƒç”¨å¤±è´¥æ—¶è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ¨¡æ‹Ÿæ•°æ®

3. **ç”¨æˆ·ä¿¡æ¯æ ‡å‡†åŒ–**ï¼šä½¿ç”¨ `web/utils/authing_manager.py` ä¸­çš„æ ‡å‡†åŒ–é€»è¾‘ç¡®ä¿ç”¨æˆ·ä¿¡æ¯ä¸€è‡´æ€§

### å…³é”®ä»£ç é€»è¾‘

```python
# åœ¨ tradingagents_server.py ä¸­
try:
    # è°ƒç”¨ Authing API è·å–çœŸå®ç”¨æˆ·ä¿¡æ¯
    token_info = self._exchange_code_for_token(code)
    user_info = self._get_user_info(access_token)
    
    # æ ‡å‡†åŒ–ç”¨æˆ·ä¿¡æ¯
    standardized_user_info = self._standardize_user_info(user_info)
    
except Exception as e:
    # è¿”å›é”™è¯¯é¡µé¢ï¼Œä¸ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    logger.error(f"Authing APIè°ƒç”¨å¤±è´¥: {e}")
    return HTMLResponse(content=error_html)
```

## ğŸ“‹ æµ‹è¯•æ¸…å•

- [ ] Authing åº”ç”¨å¯†é’¥å·²æ­£ç¡®è®¾ç½®
- [ ] ç¯å¢ƒå˜é‡å·²åŠ è½½
- [ ] Authing ç”¨æˆ·æ± ä¸­æœ‰æµ‹è¯•ç”¨æˆ·
- [ ] æµ‹è¯•ç”¨æˆ·ä¿¡æ¯å®Œæ•´ï¼ˆé‚®ç®±ã€æ‰‹æœºå·ï¼‰
- [ ] å›è°ƒåœ°å€é…ç½®æ­£ç¡®
- [ ] èƒ½å¤ŸæˆåŠŸç™»å½• Authing
- [ ] è·å–åˆ°çœŸå®çš„ç”¨æˆ·ä¿¡æ¯
- [ ] å‰ç«¯æ˜¾ç¤ºæ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### 1. åº”ç”¨å¯†é’¥é”™è¯¯
**ç—‡çŠ¶**ï¼š`invalid_client` é”™è¯¯
**è§£å†³**ï¼šæ£€æŸ¥ Authing æ§åˆ¶å°ä¸­çš„åº”ç”¨å¯†é’¥æ˜¯å¦æ­£ç¡®

### 2. ç”¨æˆ·ä¸å­˜åœ¨
**ç—‡çŠ¶**ï¼šç™»å½•æ—¶æç¤ºç”¨æˆ·ä¸å­˜åœ¨
**è§£å†³**ï¼šåœ¨ Authing æ§åˆ¶å°åˆ›å»ºç”¨æˆ·

### 3. ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´
**ç—‡çŠ¶**ï¼šè·å–åˆ°çš„é‚®ç®±æˆ–æ‰‹æœºå·ä¸ºç©º
**è§£å†³**ï¼šç¡®ä¿ Authing ç”¨æˆ·ä¿¡æ¯å®Œæ•´å¡«å†™

### 4. å›è°ƒåœ°å€ä¸åŒ¹é…
**ç—‡çŠ¶**ï¼š`redirect_uri_mismatch` é”™è¯¯
**è§£å†³**ï¼šç¡®ä¿ Authing æ§åˆ¶å°ä¸­çš„å›è°ƒåœ°å€ä¸ä»£ç ä¸­å®Œå…¨ä¸€è‡´

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤åï¼ŒAuthing SSO ç™»å½•åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… æˆåŠŸè·³è½¬åˆ° Authing ç™»å½•é¡µé¢
2. âœ… ä½¿ç”¨çœŸå®ç”¨æˆ·ç™»å½•æˆåŠŸ
3. âœ… è·å–åˆ°çœŸå®çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€é‚®ç®±ã€æ‰‹æœºå·ï¼‰
4. âœ… åœ¨å‰ç«¯æ˜¾ç¤ºæ­£ç¡®çš„ç”¨æˆ·ä¿¡æ¯
5. âœ… ç”¨æˆ·ä¿¡æ¯ä¿æŒä¸€è‡´ï¼Œä¸ä¼šéšæœºå˜åŒ–

### ğŸ”§ ç”¨æˆ·ä¿¡æ¯å¤„ç†æ”¹è¿›

é’ˆå¯¹ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´çš„æƒ…å†µï¼ˆå¦‚åªæœ‰æ‰‹æœºå·ï¼Œå…¶ä»–å­—æ®µä¸ºç©ºï¼‰ï¼Œç³»ç»Ÿç°åœ¨ä¼šï¼š

- **ç”¨æˆ·å**ï¼šä¼˜å…ˆä½¿ç”¨ `preferred_username` > `username` > `phone_number` > `sub`
- **æ˜¾ç¤ºåç§°**ï¼šä¼˜å…ˆä½¿ç”¨ `name` > `nickname` > `phone_number` > `username`
- **é‚®ç®±**ï¼šå¦‚æœä¸ºç©ºï¼Œä½¿ç”¨æ‰‹æœºå·ç”Ÿæˆ `{phone_number}@authing.demo`

**ç¤ºä¾‹**ï¼š
- åŸå§‹ä¿¡æ¯ï¼š`phone_number: "13391398973"`, `email: null`, `username: null`
- å¤„ç†åï¼š`username: "13391398973"`, `email: "13391398973@authing.demo"`

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `setup_authing_env_fixed.sh` - ä¿®å¤ç‰ˆç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬
- `web/utils/authing_manager.py` - Authing SSO ç®¡ç†å™¨
- `tradingagents_server.py` - ä¸»æœåŠ¡å™¨æ–‡ä»¶
- `frontend/src/pages/Login/index.tsx` - å‰ç«¯ç™»å½•é¡µé¢

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [Authing OIDC æ–‡æ¡£](https://docs.authing.cn/v2/concepts/oidc/)
- [Authing Scope é…ç½®](https://docs.authing.cn/v2/concepts/oidc/oidc-overview.html#scope)
- [é¡¹ç›®è®¤è¯ç³»ç»Ÿæ–‡æ¡£](../architecture/authentication.md)
