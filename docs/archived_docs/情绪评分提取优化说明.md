# 情绪评分提取优化说明

## 问题描述

从日志中发现：

```
INFO | [市场情绪分析师] LLM调用了 1 个工具
WARNING | 无法从报告中提取情绪评分，返回中性评分50
```

市场情绪分析师成功调用了工具，但是无法从报告中提取情绪评分。

## 问题原因

### 1. 工具调用结果未正确处理

当LLM调用工具时，`result.tool_calls` 包含工具调用信息，但 `result.content` 可能是空的或只是简短的响应。真正的工具输出需要通过执行工具调用来获取。

**之前的逻辑**:
```python
if tool_call_count > 0:
    # 有工具调用，直接使用result.content
    report = result.content  # ❌ 这里可能是空的或不完整
```

**优化后的逻辑**:
```python
if tool_call_count > 0:
    # 执行工具调用，获取真正的工具输出
    for tool_call in result.tool_calls:
        tool_result = tool.invoke(tool_args)
        report = str(tool_result)  # ✅ 使用工具的实际输出
```

### 2. 评分提取模式不够全面

原来的正则表达式模式较少，可能无法匹配所有格式。

## 优化内容

### 1. 增强工具调用处理

**文件**: `tradingagents/agents/analysts/market_sentiment_analyst.py`

**修改位置**: 第243-270行

**新增逻辑**:
```python
# 如果有工具调用，需要执行工具并获取结果
if tool_call_count > 0:
    logger.info(f"[市场情绪分析师] 🔧 执行工具调用...")
    
    try:
        # 执行工具调用
        tool_messages = []
        for tool_call in result.tool_calls:
            tool_name = tool_call.get('name', '')
            tool_args = tool_call.get('args', {})
            
            # 找到对应的工具并执行
            for tool in tools:
                if tool.name == tool_name:
                    tool_result = tool.invoke(tool_args)
                    tool_messages.append(tool_result)
                    break
        
        # 使用工具结果作为报告
        if tool_messages:
            report = str(tool_messages[0])
            logger.info(f"✅ 使用工具输出作为报告")
        else:
            report = result.content
            
    except Exception as e:
        logger.error(f"❌ 工具执行失败: {e}")
        report = result.content
```

### 2. 增强评分提取模式

**文件**: `tradingagents/agents/analysts/market_sentiment_analyst.py`

**修改位置**: `_extract_sentiment_score` 函数

**新增模式**:
```python
patterns = [
    # 中文格式
    r'综合情绪评分[：:]\s*(\d+\.?\d*)\s*/?\s*100',  # 综合情绪评分: 65.5 / 100
    r'综合情绪评分[：:]\s*(\d+\.?\d*)',              # 综合情绪评分: 65.5
    r'情绪评分[：:]\s*(\d+\.?\d*)\s*/?\s*100',      # 情绪评分: 65.5 / 100
    r'情绪评分[：:]\s*(\d+\.?\d*)',                  # 情绪评分: 65.5
    r'市场情绪[：:]\s*(\d+\.?\d*)',                  # 市场情绪: 65.5
    r'评分[：:]\s*(\d+\.?\d*)\s*/?\s*100',          # 评分: 65.5 / 100
    r'评分[：:]\s*(\d+\.?\d*)',                      # 评分: 65.5
    # 英文格式
    r'sentiment\s+score[：:]\s*(\d+\.?\d*)',        # sentiment score: 65.5
    r'score[：:]\s*(\d+\.?\d*)\s*/?\s*100',         # score: 65.5 / 100
    # 数字后跟"分"
    r'(\d+\.?\d*)\s*分',                            # 65.5分
    # Markdown表格格式
    r'\*\*综合情绪评分\*\*[：:]\s*(\d+\.?\d*)',     # **综合情绪评分**: 65.5
    r'\*\*情绪评分\*\*[：:]\s*(\d+\.?\d*)',         # **情绪评分**: 65.5
]
```

**备选方案**:
```python
# 如果所有模式都匹配失败，尝试查找报告中的任何0-100之间的数字
all_numbers = re.findall(r'\b(\d+\.?\d*)\b', report)
for num_str in all_numbers:
    num = float(num_str)
    if 0 <= num <= 100 and num != 50:  # 排除50（默认值）
        logger.info(f"⚠️ 使用报告中找到的数字作为情绪评分: {num}")
        return num
```

## 预期效果

### 优化前

```
2025-10-28 13:33:52 | INFO | [市场情绪分析师] LLM调用了 1 个工具
2025-10-28 13:33:52 | WARNING | 无法从报告中提取情绪评分，返回中性评分50
```

### 优化后

```
2025-10-28 13:33:52 | INFO | [市场情绪分析师] LLM调用了 1 个工具
2025-10-28 13:33:52 | INFO | [市场情绪分析师] 🔧 执行工具调用...
2025-10-28 13:33:52 | INFO | [市场情绪分析师] 执行工具: get_market_sentiment_data
2025-10-28 13:33:52 | INFO | [市场情绪分析师] ✅ 工具执行成功，结果长度: 1234 字符
2025-10-28 13:33:52 | INFO | [市场情绪分析师] ✅ 使用工具输出作为报告
2025-10-28 13:33:52 | INFO | ✅ 从报告中提取情绪评分: 65.5
```

## 测试建议

### 1. 重启服务

```bash
docker-compose restart backend
```

### 2. 运行测试

```bash
# 测试单个股票
python test_sentiment_analysis.py

# 或通过Web界面测试
# 提交一个分析请求，查看日志
```

### 3. 检查日志

查看日志中是否有：
- ✅ `执行工具调用...`
- ✅ `工具执行成功`
- ✅ `使用工具输出作为报告`
- ✅ `从报告中提取情绪评分: XX.X`

### 4. 验证结果

检查分析结果中的 `sentiment_score` 字段：
- 应该是一个0-100之间的数字
- 不应该总是50（中性）

## 技术细节

### 工具调用流程

```
LLM生成响应
  ↓
检测到tool_calls
  ↓
遍历每个tool_call
  ↓
提取tool_name和tool_args
  ↓
找到对应的工具
  ↓
执行 tool.invoke(tool_args)
  ↓
获取工具输出
  ↓
使用工具输出作为报告
  ↓
从报告中提取评分
```

### 评分提取流程

```
接收报告文本
  ↓
尝试标准模式匹配
  ↓
成功? → 返回评分
  ↓ 失败
尝试备选模式
  ↓
成功? → 返回评分
  ↓ 失败
查找0-100的数字
  ↓
找到? → 返回数字
  ↓ 失败
返回默认值50
```

## 兼容性

### 支持的LLM

- ✅ OpenAI (GPT-4, GPT-3.5)
- ✅ 阿里百炼 (Qwen)
- ✅ DeepSeek
- ✅ Google Gemini
- ✅ Anthropic Claude
- ✅ 其他OpenAI兼容的模型

### 支持的报告格式

- ✅ Markdown格式
- ✅ 纯文本格式
- ✅ 中文/英文混合
- ✅ 带表格的报告
- ✅ 带Markdown加粗的报告

## 回滚方案

如果优化后出现问题，可以回滚到之前的版本：

```python
# 简单的处理逻辑
if tool_call_count > 0:
    report = result.content if hasattr(result, 'content') else str(result)
else:
    # 强制调用工具...
```

## 总结

✅ **优化了工具调用处理** - 确保正确执行工具并获取输出
✅ **增强了评分提取** - 支持更多格式和备选方案
✅ **改进了日志** - 更详细的执行信息
✅ **提高了鲁棒性** - 多层降级策略

现在市场情绪分析师应该能够正确提取情绪评分了！
