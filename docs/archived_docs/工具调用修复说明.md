# å·¥å…·è°ƒç”¨ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ä»æ—¥å¿—ä¸­å‘ç°ä¸¤ä¸ªé—®é¢˜ï¼š

### é—®é¢˜1: å‚æ•°æ ¼å¼é”™è¯¯
```
ERROR | å·¥å…·æ‰§è¡Œå¤±è´¥: missing 2 required positional arguments: 'date' and 'market_type'
å‚æ•°: {'__arg1': "{'ticker': '688256', 'date': '2025-10-28', 'market_type': 'ä¸­å›½Aè‚¡'}"}
```

é˜¿é‡Œç™¾ç‚¼æ¨¡å‹å°†å‚æ•°åŒ…è£…æˆäº†å­—ç¬¦ä¸²æ ¼å¼ã€‚

### é—®é¢˜2: å·¥å…·å‚æ•°æ•°é‡é”™è¯¯
```
ERROR | å·¥å…·æ‰§è¡Œå¤±è´¥: Too many arguments to single-input tool get_market_sentiment_data
```

`Tool` ç±»é»˜è®¤åªæ”¯æŒå•ä¸ªå‚æ•°ï¼Œä½†æˆ‘ä»¬çš„å‡½æ•°æœ‰3ä¸ªå‚æ•°ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤å‚æ•°è§£æï¼ˆå¸‚åœºæƒ…ç»ªåˆ†æå¸ˆï¼‰

**æ–‡ä»¶**: `tradingagents/agents/analysts/market_sentiment_analyst.py`

**æ·»åŠ å‚æ•°è§£æé€»è¾‘**:
```python
# å¤„ç†é˜¿é‡Œç™¾ç‚¼çš„ç‰¹æ®Šå‚æ•°æ ¼å¼
if '__arg1' in tool_args and isinstance(tool_args['__arg1'], str):
    try:
        import json
        import ast
        arg_str = tool_args['__arg1']
        # å…ˆå°è¯•JSONè§£æ
        try:
            parsed_args = json.loads(arg_str)
        except:
            # å¦‚æœJSONå¤±è´¥ï¼Œå°è¯•ast.literal_eval
            parsed_args = ast.literal_eval(arg_str)
        
        tool_args = parsed_args
        logger.info(f"ğŸ”§ è§£æåçš„å‚æ•°: {tool_args}")
    except Exception as e:
        logger.warning(f"âš ï¸ å‚æ•°è§£æå¤±è´¥: {e}")
```

### 2. ä½¿ç”¨StructuredToolï¼ˆæƒ…ç»ªåˆ†æå·¥å…·ï¼‰

**æ–‡ä»¶**: `tradingagents/tools/sentiment_tools.py`

**ä¿®æ”¹å‰**:
```python
from langchain_core.tools import Tool

def create_sentiment_analysis_tool(...) -> Tool:
    def get_market_sentiment_data(ticker: str, date: str, market_type: str) -> str:
        ...
    
    tool = Tool(
        name="get_market_sentiment_data",
        description="...",
        func=get_market_sentiment_data  # âŒ Toolåªæ”¯æŒå•å‚æ•°
    )
    return tool
```

**ä¿®æ”¹å**:
```python
from langchain_core.tools import Tool, StructuredTool
from pydantic import BaseModel, Field as PydanticField

def create_sentiment_analysis_tool(...) -> StructuredTool:
    # å®šä¹‰è¾“å…¥æ¨¡å‹
    class SentimentAnalysisInput(BaseModel):
        ticker: str = PydanticField(description="è‚¡ç¥¨ä»£ç ")
        date: str = PydanticField(description="åˆ†ææ—¥æœŸ (YYYY-MM-DD)")
        market_type: str = PydanticField(description="å¸‚åœºç±»å‹")
    
    def get_market_sentiment_data(ticker: str, date: str, market_type: str) -> str:
        ...
    
    # ä½¿ç”¨StructuredToolæ”¯æŒå¤šå‚æ•°
    tool = StructuredTool.from_function(
        func=get_market_sentiment_data,
        name="get_market_sentiment_data",
        description="...",
        args_schema=SentimentAnalysisInput  # âœ… æ˜ç¡®å®šä¹‰å‚æ•°ç»“æ„
    )
    return tool
```

## æŠ€æœ¯ç»†èŠ‚

### Tool vs StructuredTool

| ç‰¹æ€§ | Tool | StructuredTool |
|------|------|----------------|
| å‚æ•°æ•°é‡ | å•ä¸ª | å¤šä¸ª |
| å‚æ•°ç±»å‹ | å­—ç¬¦ä¸² | ç»“æ„åŒ–ï¼ˆPydanticï¼‰ |
| ç±»å‹æ£€æŸ¥ | æ—  | æœ‰ |
| æ–‡æ¡£ç”Ÿæˆ | ç®€å• | è¯¦ç»† |
| LLMç†è§£ | è¾ƒå·® | è¾ƒå¥½ |

### ä¸ºä»€ä¹ˆä½¿ç”¨StructuredToolï¼Ÿ

1. **æ˜ç¡®çš„å‚æ•°å®šä¹‰**: LLMèƒ½æ›´å¥½åœ°ç†è§£éœ€è¦å“ªäº›å‚æ•°
2. **ç±»å‹å®‰å…¨**: Pydanticè‡ªåŠ¨éªŒè¯å‚æ•°ç±»å‹
3. **æ›´å¥½çš„é”™è¯¯æç¤º**: å‚æ•°é”™è¯¯æ—¶æœ‰æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
4. **å…¼å®¹æ€§**: æ”¯æŒæ‰€æœ‰LLMæä¾›å•†çš„å·¥å…·è°ƒç”¨æ ¼å¼

### é˜¿é‡Œç™¾ç‚¼çš„ç‰¹æ®Šå¤„ç†

é˜¿é‡Œç™¾ç‚¼ï¼ˆDashScopeï¼‰åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå°†å‚æ•°åŒ…è£…æˆå­—ç¬¦ä¸²ï¼š
```python
# æ­£å¸¸æ ¼å¼
{'ticker': '688256', 'date': '2025-10-28', 'market_type': 'ä¸­å›½Aè‚¡'}

# é˜¿é‡Œç™¾ç‚¼æ ¼å¼
{'__arg1': "{'ticker': '688256', 'date': '2025-10-28', 'market_type': 'ä¸­å›½Aè‚¡'}"}
```

æˆ‘ä»¬çš„è§£æé€»è¾‘ä¼šè‡ªåŠ¨å¤„ç†è¿™ä¸¤ç§æ ¼å¼ã€‚

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰

```
ERROR | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] æ‰§è¡Œå·¥å…·: get_market_sentiment_data
ERROR | å‚æ•°: {'__arg1': "{'ticker': '688256', ...}"}
ERROR | âŒ å·¥å…·æ‰§è¡Œå¤±è´¥: Too many arguments to single-input tool
WARNING | âš ï¸ æ— æ³•ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†ï¼Œè¿”å›ä¸­æ€§è¯„åˆ†50
```

### ä¿®å¤å

```
INFO | [å¸‚åœºæƒ…ç»ªåˆ†æå¸ˆ] æ‰§è¡Œå·¥å…·: get_market_sentiment_data
INFO | åŸå§‹å‚æ•°: {'__arg1': "{'ticker': '688256', ...}"}
INFO | ğŸ”§ è§£æåçš„å‚æ•°: {'ticker': '688256', 'date': '2025-10-28', 'market_type': 'ä¸­å›½Aè‚¡'}
INFO | âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸï¼Œç»“æœé•¿åº¦: 1234 å­—ç¬¦
INFO | âœ… ä½¿ç”¨å·¥å…·è¾“å‡ºä½œä¸ºæŠ¥å‘Š
INFO | âœ… ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†: 65.5
```

## æµ‹è¯•æ­¥éª¤

### 1. é‡å¯æœåŠ¡

```bash
docker-compose restart backend
```

### 2. æäº¤æµ‹è¯•åˆ†æ

```bash
# é€šè¿‡Webç•Œé¢æˆ–APIæäº¤ä¸€ä¸ªåˆ†æè¯·æ±‚
# è‚¡ç¥¨ä»£ç : 688256 (å¯’æ­¦çºª)
```

### 3. æŸ¥çœ‹æ—¥å¿—

æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
- âœ… `ğŸ”§ è§£æåçš„å‚æ•°`
- âœ… `âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ`
- âœ… `âœ… ä»æŠ¥å‘Šä¸­æå–æƒ…ç»ªè¯„åˆ†`

### 4. éªŒè¯ç»“æœ

æ£€æŸ¥åˆ†æç»“æœï¼š
- `market_sentiment_report` åº”è¯¥åŒ…å«å®Œæ•´çš„æƒ…ç»ªåˆ†ææŠ¥å‘Š
- `sentiment_score` åº”è¯¥æ˜¯ä¸€ä¸ªæœ‰æ„ä¹‰çš„æ•°å­—ï¼ˆä¸æ€»æ˜¯50ï¼‰

## å…¼å®¹æ€§

### æ”¯æŒçš„LLM

ä¿®å¤åæ”¯æŒæ‰€æœ‰ä¸»æµLLMï¼š

- âœ… **OpenAI** (GPT-4, GPT-3.5)
- âœ… **é˜¿é‡Œç™¾ç‚¼** (Qwen) - ç‰¹æ®Šå‚æ•°æ ¼å¼å·²å¤„ç†
- âœ… **DeepSeek** (DeepSeek-V3)
- âœ… **Google** (Gemini)
- âœ… **Anthropic** (Claude)
- âœ… **å…¶ä»–OpenAIå…¼å®¹æ¨¡å‹**

### å·¥å…·è°ƒç”¨æ ¼å¼

æ”¯æŒå¤šç§å·¥å…·è°ƒç”¨æ ¼å¼ï¼š

```python
# æ ‡å‡†æ ¼å¼
{'ticker': '688256', 'date': '2025-10-28', 'market_type': 'ä¸­å›½Aè‚¡'}

# é˜¿é‡Œç™¾ç‚¼æ ¼å¼
{'__arg1': "{'ticker': '688256', 'date': '2025-10-28', 'market_type': 'ä¸­å›½Aè‚¡'}"}

# JSONå­—ç¬¦ä¸²æ ¼å¼
{'__arg1': '{"ticker": "688256", "date": "2025-10-28", "market_type": "ä¸­å›½Aè‚¡"}'}
```

## ç›¸å…³ä¿®æ”¹

### ä¿®æ”¹çš„æ–‡ä»¶

1. **tradingagents/tools/sentiment_tools.py**
   - å¯¼å…¥ `StructuredTool` å’Œ `Pydantic`
   - å®šä¹‰ `SentimentAnalysisInput` æ¨¡å‹
   - ä½¿ç”¨ `StructuredTool.from_function` åˆ›å»ºå·¥å…·

2. **tradingagents/agents/analysts/market_sentiment_analyst.py**
   - æ·»åŠ å‚æ•°è§£æé€»è¾‘
   - å¤„ç†é˜¿é‡Œç™¾ç‚¼çš„ç‰¹æ®Šæ ¼å¼
   - æ”¹è¿›æ—¥å¿—è¾“å‡º

## æ€»ç»“

âœ… **ä¿®å¤äº†å·¥å…·å‚æ•°é—®é¢˜** - ä½¿ç”¨StructuredToolæ”¯æŒå¤šå‚æ•°
âœ… **å¤„ç†äº†é˜¿é‡Œç™¾ç‚¼æ ¼å¼** - è‡ªåŠ¨è§£æç‰¹æ®Šå‚æ•°æ ¼å¼
âœ… **æ”¹è¿›äº†é”™è¯¯å¤„ç†** - æ›´è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
âœ… **æé«˜äº†å…¼å®¹æ€§** - æ”¯æŒæ‰€æœ‰ä¸»æµLLM

ç°åœ¨å¸‚åœºæƒ…ç»ªåˆ†æåŠŸèƒ½åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œäº†ï¼
